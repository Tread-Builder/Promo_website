!function(){"use strict";const e={displayModes:{DESKTOP:0,MOBILE:1}},t={websocket:!1,client:{interval:5e3,targetUrl:"https://heatmap-events-collector.instapage.com",clientVersion:2,error:{timeout:1e4,maxOccurrence:3},trackers:{eventsList:["onclick","onmousemove","onscroll"],mouseMoveTimeout:80},windowProperties:{normalMobileWidth:400}}},i=window._debugMode;function o(e){const t=[],i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;o+=1)t.push(i.charAt(Math.floor(Math.random()*i.length)));return t.join("")}function n(e,t){let i;return(...o)=>{clearTimeout(i),i=setTimeout(()=>e(...o),t)}}function s(e){const{innerWidth:t,__page_generator:o,__config:n,__mobile_version:s}=e;if(o){const e=n&&n.mobileDisabled;return i&&console.log("isMobileMode PG:",!e&&t<768,t,768),!e&&t<768}return i&&console.log("isMobileMode",s&&t<768,t,768),s&&t<620}function a(e){return e.scrollY||e.document.scrollTop||e.document.body.scrollTop||0}class r{constructor(e){this.ajaxPath="/api/raw-data",this.websocketPath="/ws/raw-data",this.options=e,this.useBeacon=!1}getFullRESTPath(){return this.options.targetUrl+this.ajaxPath}sendByAjax(e){return fetch(this.getFullRESTPath(),{method:"POST",headers:{connection:"keep-alive"},body:JSON.stringify(e)}).then(e=>e.ok?Promise.resolve(e):Promise.reject(e))}sendByBeacon(e){if(navigator&&navigator.sendBeacon){const t=this.getFullRESTPath();try{return navigator.sendBeacon(t,JSON.stringify(e)),Promise.resolve()}catch(t){return this.sendByAjax(e)}}return this.sendByAjax(e)}send(e){return this.useBeacon?this.sendByBeacon(e):this.sendByAjax(e)}}class l{constructor(e){this.pixelRatio=1,this.isMobileModeOn=s(e.window),this.options=e,this.isPopupOpened=!1,this.popupId=!1,this.errorCount=0,this.sendTimestamp=0,this.enableSend=!0,this.request=new r(e),this.sentScrollDesktop=0,this.sentScrollMobile=0,this.currentMaxScrollDesktop=0,this.currentMaxScrollMobile=0,this.storage=[],this.singleSessionStorage={},this.resetStorage()}resetStorage(){this.singleSessionStorage.mousemove=[],this.singleSessionStorage.click=[]}wrapDataToSend(e){return{displayMode:this.displayMode,sessionId:this.options.sessionId,pageId:this.options.pageId,version:this.options.pageVersion,variation:this.options.pageVariation,variationHash:this.options.pageVariationHash,popupId:this.popupId,clientVersion:this.options.clientVersion,data:e}}checkForDisplayModeChange(){this.displayMode?(this.isMobileModeOn||this.addDataToStorage(),this.isMobileModeOn=!0):(this.isMobileModeOn&&this.addDataToStorage(),this.leftEdgeElement||this.findEdgeElements(),this.isMobileModeOn=!1)}isPointInBoundaries({x:e,y:t}){const{leftMargin:i,topMargin:o,width:n,height:s}=this;return i<e&&i+n>e&&o<t&&o+s>t}findEdgeElements(){const{innerSection:e,options:{isPageGenerator:t,window:{document:{body:i,body:{clientWidth:o}}}}}=this;let[n,s]=[o,0],a=[];a=t?i.getElementsByTagName("main").item(0).getElementsByClassName("widget"):i.getElementsByClassName("block-inner");for(let e=0;e<a.length;e++){const t=a.item(e),{left:i,right:o,width:r}=t.getBoundingClientRect();r&&n>i&&(n=i,this.leftEdgeElement=t),r&&s<o&&(s=o,this.rightEdgeElement=t)}if(a.length){const{left:t,right:i}=e.getBoundingClientRect();n>t&&(this.leftEdgeElement=e),s<i&&(this.rightEdgeElement=e)}else this.leftEdgeElement=e,this.rightEdgeElement=e;this.leftEdgeElement||(this.leftEdgeElement=e),this.rightEdgeElement||(this.rightEdgeElement=e),this.leftEdgeElement||(this.enableSend=!1)}findInnerSection(){const{isPageGenerator:e,window:{document:{body:t}}}=this.options,i=e?"section-inner":"block-inner",o=t.getElementsByClassName(i);for(let e=0;e<o.length;e++){const t=o.item(e);if(t.clientWidth)return void(this.innerSection=t)}this.innerSection||(this.enableSend=!1)}updateHeatmapDivBoundaries(){const{isPageGenerator:t,heatmapDiv:o,window:{innerWidth:n,scrollX:a,scrollY:r,document:{body:{offsetHeight:l}}}}=this.options;let d,h,c,p,g,u=0;if(this.displayMode=function(t){return e.displayModes[s(t)?"MOBILE":"DESKTOP"]}(window),this.checkForDisplayModeChange(),this.setMaxScroll(),this.isMobileModeOn){const{width:e,left:t}=this.innerSection.getBoundingClientRect();p=e,d=t,c=l}else d=this.leftEdgeElement.getBoundingClientRect().left,h=this.rightEdgeElement.getBoundingClientRect().right,c=l,p=h-d;if(this.isPopupOpened){const{left:e,right:t,height:i,width:o,top:n}=this.popupElement.getBoundingClientRect();d=e,u=n+r,h=t,c=i,p=o}if(d+=a,t)if(g=d,this.isMobileModeOn)this.pixelRatio=n<400?400/n:1;else{const{width:e}=this.innerSection.getBoundingClientRect();this.pixelRatio=960/e}else g=d>0?d:0;i&&console.log("Pixel ratio:",this.pixelRatio),this.leftMargin=g,this.topMargin=u,this.width=p,this.height=c,o.style.left=`${g}px`,o.style.width=`${p}px`,o.style.height=`${c}px`,o.style.top=`${u}px`}addPointToStorage(e,t,o){const{leftMargin:n,topMargin:s,pixelRatio:a,height:r,width:l}=this,d=t-n,h=o-s;d<0||h<0||d>l||h>r||!a||(i&&"click"===e&&(console.log("addPointToStorage:",d,h,n,s,l,r),console.log("with pixelRatio:",Math.round(d*a),Math.round(h*a))),this.singleSessionStorage[e].push({x:Math.round(d*a),y:Math.round(h*a)}))}setMaxScroll(){const{displayMode:e,currentMaxScrollMobile:t,currentMaxScrollDesktop:o,height:n,options:{window:s}}=this,r=Math.floor(a(s)+s.innerHeight),l=Math.floor(n),d=r>l?l:r;e&&t<d?this.currentMaxScrollMobile=d:!e&&o<d&&(this.currentMaxScrollDesktop=d),i&&console.log("setMaxScroll:::","displayMode:",e,"scroll:",d,"currentMaxScrollMobile",this.currentMaxScrollMobile,"currentMaxScrollDesktop",this.currentMaxScrollDesktop)}addDataToStorage(){const{currentMaxScrollMobile:e=0,currentMaxScrollDesktop:t=0,displayMode:i,sentScrollMobile:o,sentScrollDesktop:n,pixelRatio:s}=this,a=Math.floor((i?e:t)*s),r=i?o:n,l=[];if(this.singleSessionStorage.mousemove.length&&l.push({eventName:"mousemove",data:this.singleSessionStorage.mousemove}),this.singleSessionStorage.click.length&&l.push({eventName:"click",data:this.singleSessionStorage.click}),a&&r<a&&(l.push({eventName:"scroll",data:[{y:a}]}),i?this.sentScrollMobile=a:this.sentScrollDesktop=a),this.resetStorage(),l.length){const e=this.wrapDataToSend(l);this.storage.push(e)}}sendBeacon(){for(this.addDataToStorage();this.storage.length;){const e=this.storage.shift();this.request.send(e)}}sendData(){if(this.enableSend&&this.storage.length&&Date.now()>this.sendTimestamp){const e=this.storage.shift();this.request.send(e).then(()=>{this.errorCount=0}).catch(t=>{console.error(t);const{options:{error:i}}=this;this.errorCount+=1,this.errorCount<i.maxOccurrence?this.sendTimestamp=Date.now()+i.timeout:this.enableSend=!1,this.storage.push(e)})}}init(){this.isMobileModeOn=s(this.options.window),this.findInnerSection(),this.isMobileModeOn||this.findEdgeElements(),this.updateHeatmapDivBoundaries(),this.resetStorage(),this.setMaxScroll(),setInterval(()=>{this.addDataToStorage(),setTimeout(()=>{this.sendData()},this.options.interval/2)},this.options.interval)}}function d(){if(!window.__preview){const{__variant:e,__variant_hash:s,__version:r,__page_id:d,__page_generator:h,__workspaceWidth:c=960,__page_domain:p,location:{href:g}}=window;(!p||p&&-1===g.indexOf(p.replace("//","")))&&console.log("HEATMAP EVENTS COLLECTING BLOCKED");const{websocket:u,client:{targetUrl:m,interval:w,error:M,windowProperties:S,clientVersion:E,trackers:f}}=t,y=document.createElement("div");i&&document.body.appendChild(y);const v={window:window,heatmapDiv:y,pageVariationHash:s,interval:w,error:M,pageId:d,pageVersion:r,targetUrl:m,windowProperties:S,workspaceWidth:c,trackers:f,isPageGenerator:h,clientVersion:h?3:E,pageVariation:e.split("-")[0],sessionId:o(12),websocket:"true"===u||!0===u},b=new l(v);window._htmp=b;const x=/iPhone|iPad/i.test(window.navigator.userAgent);let B=!1;const D=()=>{B||(b.request.useBeacon=!0,b.sendBeacon()),B=!0};i&&(y.setAttribute("id","heatmapDiv"),y.style.position="absolute",y.style.top="0px",y.style.left="0px",y.style.opacity=0,y.style.background="green",y.style.zIndex=1);const T=function(e,t){let i=0;return function(...o){const n=(new Date).getTime();if(!(n-i<e))return i=n,t(...o)}}(f.mouseMoveTimeout,b.addPointToStorage.bind(b)),k=({type:e,pageX:t,pageY:o,clientX:n,clientY:s})=>{const r=a(window),l=function(e){return e.scrollX||e.document.scrollLeft||e.document.body.scrollLeft||0}(window);let d,h;if(null==t||null==o){const{documentElement:{clientLeft:e,clientTop:t},body:{clientLeft:i,clientTop:o}}=document;d=n+l-(e||i||0),h=s+r-(t||o||0)}else d=t,h=o;b.isPointInBoundaries({x:d,y:h})&&("mousemove"!==e||b.isMobileModeOn&&x?"click"===e&&(b.addPointToStorage(e,d,h),i&&(console.log("mouse click event",d,h),console.log("SIZE:","heatmapDiv.width:",y.style.width,"window.outerWidth",window.outerWidth,"heatmapDiv.style.height",y.style.height,"window.outerHeight",window.outerHeight))):T(e,d,h))},P=()=>{b.isPopupOpened&&b.updateHeatmapDivBoundaries()};let _;const O=e=>{const t=e.detail,o=t.id||t.data.id,n=document.getElementById(`popup-${o}`);b.addDataToStorage();const s=h?n.getElementsByClassName("lightbox-content")[0]:n.getElementsByClassName("popup-inner")[0];b.popupId=o,b.isPopupOpened=!0,b.popupElement=s,i&&(y.style.zIndex=10500001),setTimeout(()=>{_=s.parentElement,_.addEventListener("scroll",P),b.updateHeatmapDivBoundaries()},500)},I=()=>{_.removeEventListener("scroll",P),b.addDataToStorage(),i&&(y.style.zIndex=1),b.popupId=!1,b.isPopupOpened=!1,setTimeout(()=>{b.updateHeatmapDivBoundaries()},h?1:200)},C=()=>{b.setMaxScroll()};b.init(document.body.firstElementChild),window.addEventListener("preview.popup.shown",e=>setTimeout(()=>O(e))),window.addEventListener("preview.popup.hide",e=>setTimeout(()=>I())),window.addEventListener("resize",n(b.updateHeatmapDivBoundaries.bind(b),350)),window.addEventListener("scroll",n(C.bind(this),100)),window.document.addEventListener("mousemove",k,!0),window.document.addEventListener("click",k,!0),i&&window.addEventListener("keyup",e=>{"h"===e.key?y.style.opacity=0:"s"===e.key&&(y.style.opacity=.3)}),window.addEventListener("beforeunload",D.bind(this)),window.addEventListener("unload",D.bind(this))}}"complete"===document.readyState||"loaded"===document.readyState?d():window.addEventListener?window.addEventListener("load",d):window.attachEvent?window.attachEvent("onreadystatechange",()=>{"complete"===document.readyState&&d()}):console.error("Unsupported browser")}();
